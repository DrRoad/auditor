---
title: "The half-normal plots"
author: "Alicja Gosiewska"
date: "`r Sys.Date()`"
output: html_document
vignette: >
  %\VignetteEngine{knitr::knitr}
  %\VignetteIndexEntry{The half-normal plots}
  %\usepackage[UTF-8]{inputenc}
---


```{r setup, echo = FALSE}
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
```

# Half-normal plot


The half-normal plot presented in this chapter is one of the tools designed to evaluate the goodness of fit of a statistical model. It is a graphical method for comparing two probability distributions by plotting their quantiles against each other.

Points on the plot correspond to ordered absolute values of model diagnostic (i.e. standardized residuals) plotted against theoretical order statistics from a half-normal distribution.

There are various implementations of half-normal plots in R. Functions for generating such plotes are available in packages **auditor**, **faraway**, **hnp**, but also in others.
Some functions can only draw a simple half-normal plot, while some have additional functionalities like a simulated envelope and score of goodness-of-fit. 

Below we present example of the use of half-normal plots for a generalized linear models regression. 
Plots are generated by `plotHalfNormal` function from package **auditor**.
By default, deviance residuals were used as diagnostic values.

# Simulations

Used to confirm scores.

```{r}
set.seed(123)
library(auditor)
```

Data 

```{r}
ilogit <- function(x){ exp(x)/(1+exp(x))}
mu <- 0.25
sigma <- 0.5
n <- 100

eps <- rnorm(n, mu, sigma)  
ps <- ilogit(mu+eps)
y <- rbinom(n, 100, ps)
symulacja <- data.frame(y=y, alive = 100-y)
x <- factor(seq_len(nrow(symulacja)))
```

### Fitting binomial-logit-normal model

If diagnostic values are from the normal distribution, they are close to a straight line. 
However, if they don't come from a normal distribution, they still show a certain trend. Simulated envelopes can be used to help verify the correctness of this trend.
For a well-fitted model, diagnostic values should lay within the envelope.

A useful tool to compare goodness-of-fit of two models is Score calculated by `plotHalfNormal` function. It is a sum of logarithms of estimated PDF at each point. Scores are calculated on the basis of simulated data, so they may differ between function calls.

```{r binomial-logit, results='hide', fig.keep='all'}
library("lme4")
mod <- glmer(cbind(y, alive) ~ (1 | x), family = binomial, data = symulacja)
plotHalfNormal(mod)
```

### Fitting other models

Logistic regression
```{r binomial, results='hide', fig.keep='all'}
mod2 <- glm(cbind(y, alive) ~ 1, family = binomial, data = symulacja)
plotHalfNormal(mod2)
```
Doesn't fit because of overdispersion in data

Quasi-binomial model which is overdispersion model.
```{r quasibinomial, results='hide', fig.keep='all'}
mod3 <- glm(cbind(y, alive) ~ 1, family = quasibinomial, data = symulacja)
plotHalfNormal(mod3)
```

And beta-binomial model.
```{r beta-binomial, results='hide', fig.keep='all'}
library("aods3")
mod4 <- aodml(cbind(y, alive) ~ 1, family = "bb", data = symulacja)
plotHalfNormal(mod4)
```

None of those models seems to fit as well as Logistic regression model binomial-logit-normal model which is understandable, because data comes from binomial-logit-normal distribution. Score values confirm that the BLN model is best fitted.

# Use case

Dataset corn from hnp package. **There will be description of data**

```{r, results='hide', fig.keep='all'}
data("corn", package = "hnp")
head(corn)
```


```{r binomial2, results='hide', fig.keep='all'}
model.bin <- glm(cbind(y, m - y) ~ extract, family = binomial, data = corn)
plotHalfNormal(model.bin, sim=500)
```

Other glm models
```{r quasibinomial2, results='hide', fig.keep='all'}
fit2_b <- glm(cbind(y, m - y) ~ extract, family = quasibinomial, data = corn)
plotHalfNormal(fit2_b, sim=500)
```

```{r beta-binomial2, results='hide', fig.keep='all'}
fit3_b <- aodml(cbind(y, m - y) ~ extract, family = "bb", data = corn)
plotHalfNormal(fit3_b, sim=500)
```

```{r normal-logit-binomial, results='hide', fig.keep='all'}
x <- factor(seq_len(nrow(corn)))
fit4_b <- glmer(cbind(y, m - y) ~ extract + (1 | x), family = binomial, data = corn)
plotHalfNormal(fit4_b, sim=500)
```


## Quantile scale
In function `plotHalfNormal` there is also a posibility to draw half-normal plot on a quantile scale.
```{r, results='hide', fig.keep='all'}
plotHalfNormal(fit4_b, quant.scale = TRUE)
```


# Classification

HalfNormal plots works also for classification random Forest

```{r}
iris.rf <- randomForest(Species ~ ., data=iris)
plotHalfNormal(iris.rf)
```



### References

Gosiewska Alicja, Biecek Przemysław.2018. *auditor - audit/verification of regression models* https://github.com/mi2-warsaw/auditor

Moral, R., Hinde, J., & Demétrio, C. (2017). *Half-Normal Plots and Overdispersed Models in R: The hnp Package*. Journal of Statistical Software, 81(10), 1 - 23. doi:http://dx.doi.org/10.18637/jss.v081.i10
